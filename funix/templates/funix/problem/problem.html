{% extends 'funix/problem/problem-base.html' %}


{% block media_child %}
    {{ form.media.css }}
    <link rel="stylesheet" href="{{ static('plugins/css/resizable.min.css') }}">
    <link rel="stylesheet" href="{{ static('funix/css/problem.css') }}">
{% endblock %}

{% block js_media %}
    <script src="{{static('plugins/js/resizable.min.js')}}" type="text/javascript"></script>
    <script type="text/javascript" src="{{ ACE_URL }}/ace.js"></script>
    {{ form.media.js }}

    {% compress js %}
        {% include 'funix/problem/ace-editor.html' %}
    {% endcompress %}

    <script type="text/javascript" src="{{ static('event.js') }}"></script>
    {% if submission and not submission.is_graded and last_msg %}
        {% include "funix/problem/js-event.html" %}
    {% endif %}

    {% if submission and not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                $(document).keydown(function(e) {
                    // Ctrl-Enter or Command-Enter
                    if ((e.metaKey || e.ctrlKey) && e.which == 13) {
                        $('#abort-button form').submit();
                    }
                });
            });
        </script>
    {% endif %}
{% endblock %}

{% block problem_content %} 
    {% if submission %}
    {% set is_processing = submission is not none %}
    {% endif %}

    <div class="problem_container">
        <div class="topbar">
            <span> {% if content_title %}{{ content_title }}{% else %}{{ title }}{% endif %}</span>
    
        </div>

        <div class="main">
            <div class="problem_details">
                 {% include "funix/problem/problem-details.html" %} 
            </div>


            <div class="codeplace">
                {% if not request.user.is_authenticated %}
                    <div class="login_required_overlay">
                        <div>
                            <p>Login is needed to make submission</p>
                            <a href="{{ url('auth_login') }}?next={{ LOGIN_RETURN_PATH|urlencode }}">{{ _('Login!') }}</a>
                        </div>
                    </div>
                {% else %}

                    <div class="toolbar">
                        {% include "funix/problem/toolbar.html" %}
                    </div>

                    {# uuuuvcomment ------------------------- submission form ------------------------- #}
                    <form id="problem_submit" method="POST">
                        {# uuuuvcomment ------------------------- choose languages ------------------------- #}
                        {% if not no_judges %}
                           <div id="language-bar">
                            <div id="language">
                                {{ form.language.errors }}
                                <div id="language-select">
                                    <select id="id_language" name="language">
                                        {% for lang in form.fields.language.queryset %}
                                            <option 
                                                value="{{ lang.id }}" 
                                                data-id="{{ lang.id }}" 
                                                data-name="{{ lang.name }}"
                                                data-info="{{ lang.info }}" 
                                                data-ace="{{ lang.ace }}"
                                                data-judge-info="{{ runtime_versions(lang.runtime_versions()) }}"
                                                {% if lang.id == default_lang.id %}selected{% endif %}
                                            >
                                                {{ lang.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                           </div>
                        {% endif %}

                        {# uuuuvcomment ------------------------- warning ------------------------- #}
                        <div class="codeplace_warning">
                            {% if not no_judges %}
                                {% if default_lang not in form.fields.language.queryset %}
                                    <div class="alert alert-warning alert-dismissable">
                                        <a class="close">x</a>
                                        <b>{{ _('Warning!') }}</b>
                                        {{ _('Your default language, %(language)s, is unavailable for this problem and has been deselected.', language=bold(default_lang.name)) }}
                                    </div>
                                {% endif %}
                        
                                {% if request.in_contest and submission_limit %}
                                    {% if submissions_left > 0 %}
                                        <div class="alert alert-warning alert-dismissable">
                                            <a class="close">x</a>
                                            {% trans left=submissions_left -%}
                                                You have {{ left }} submission left
                                                {%- pluralize -%}
                                                You have {{ left }} submissions left
                                            {%- endtrans %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning alert-dismissable">
                                            <a class="close">x</a>
                                            {{ _('You have 0 submissions left') }}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>

                        {# uuuuvcomment ------------------------- editor ------------------------- #}
                        <div class="codeplace_editor">
                            {% csrf_token %}
                            {{ form.non_field_errors() }}
                            <div id="submit-wrapper">
                                <div id="editor">
                                    {{ form.source.errors }}
                                    {{ form.source }}
                                </div>
                            </div>
                        </div>

                        {# uuuuvcomment ------------------------- submit button ------------------------- #}
                        {# uuuuvcomment ------------------ or no judge is available --------------------- #}
                        <div class="submitbar">
                            {% if no_judges %}
                                <span style="color: red">{{ _('No judge is available for this problem.') }}</span>
                            {% else %}
                                <div class="submit-bar">
                                    <div>
                                        {{ form.judge }}
                                    </div>

                                    <div class="submitbar_buttons">
                                        <input id="submit-button"  type="submit" value="{% if submission %}{{ _('Resubmit!') }}{% else %}{{ _('Submit') }}{% endif %}" class="button accent"
                                        {% if request.in_contest and submission_limit and not submissions_left %}disabled{% endif %}>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </form>
            
                    <div id="event-update" class="submission">
                        {# uuuuvcomment ------------------------- submission nav ------------------------- #}
                        {% include 'funix/problem/testcases-and-submission.html' %}
                        
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% compress js %}
        {% include "funix/problem/js-ace-editor-extra.html" %}
        {% include "funix/problem/js-resizing.html" %}
        {% include "funix/problem/js-tabs.html" %}
    {% endcompress %}

    <script type="text/javascript">
        function sidebarNavigate(event, tab) {
            console.log(tab);
            if (tab == 'problem-details') {
                $.ajax({
                    url: '{{ url('beta_problem_details') }}',
                    data: {code: '{{ problem.code }}'}
                }).done(function (data) {
                    console.log("Details")
                    console.log(data)
                    document.querySelector('.problem_details').innerHTML = data
                      
                }).fail(function (data) {
                    console.log('Failed to update testcases!');
                });
            }

            if (tab == 'problem-comments') {
                $.ajax({
                    url: '{{ url('beta_problem_comments', problem.code) }}',
                    data: {code: '{{ problem.code }}'}
                }).done(function (data) {
                    console.log("Comments")
                    console.log(data)
                    document.querySelector('.problem_details').innerHTML = data
                      
                }).fail(function (data) {
                    console.log('Failed to update testcases!');
                });
            }
        }
    </script>


    <script type="text/javascript">
        $.ajax({
            type:'POST',
            url:'{% url "create" %}',
            data:{
                title:$('#title').val(),
                description:$('#description').val(),
                csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                action: 'post'
            },
            success:function(json){
                document.getElementById("post-form").reset();
                $(".posts").prepend('<div class="col-md-6">'+
                    '<div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">' +
                        '<div class="col p-4 d-flex flex-column position-static">' +
                            '<h3 class="mb-0">' + json.title + '</h3>' +
                            '<p class="mb-auto">' + json.description + '</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' 
                )
            },
            error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
        });
    </script>
{% endblock %}